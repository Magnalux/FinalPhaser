<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Phaser Project 1</title>
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <script src="js/phaser.min.js"></script>
    </head>
    <body>
        <!-- <h1 class="center-text">Destroy the Castle</h1> -->
        <div id="gameArea"></div>
        
        <script type="text/javascript">
            /*
            FOR NEXT ITERATION:
            Goal: make the camera follow one fighter as they walk around
            Due:  next wednesday, 4/4
            Steps:
            By end of mondady:
            1.  Draw the animation sheet for the paladin-type fighter
                a.  Moving Right
                b.  Moving Left
                c.  Jumping
                d.  Landing
                e.  Attacking
                f.  Shielding
                g.  Dieing
                h.  Taking Damage (minor)
                i.  Taking Damage (moderate)
                j.  Taking Damage (major, should get flown back)
                
                Only two possible directions to face: just flip the image horizontally to face the other direction
            
            By end of wednesday:
            2.  Make the fighter be animated to move right all the time
            3.  Make the fighter animated only when a directional key is pressed (use 'wasd' controls)
            4.  Make the fighter move with the animation when a directional key is pressed
            5.  Make the fighter jump when space is pressed
            
            There does not need to be complex terrain (yet). Just make sure there are some platforms to jump on in order to test movement
            */

            window.onload = function() {
                var GRAVITY = 175;
                var GRENADE_VELOCITY = 500;
                var EXPLOSION_VELOCITY = 300;
                var GRENADE_LIFETIME = 400;
                var EXPLOSION_LIFETIME = 300;
                var game = new Phaser.Game(800, 600, Phaser.AUTO, 'gameArea', { preload: preload, create: create, update: update });
                var platforms;
                var objectCollisionGroup;
                var objects;
                var peopleCollisionGroup;
                var people;
                var grenadeCollisionGroup;
                var grenadeCollided;
                var projectiles;
                var shardCollisionGroup;
                var mouseWasDown = false;
                var currentLevel;
                var teams;

                function preload () {
                    game.load.image('background', 'img/Background.png');
                    game.load.image('blackbox', 'img/Blackbox.png');
                    game.load.image('ground', 'img/Ground.png');
                    game.load.image('grenade', 'img/Grenade.png');
                    game.load.image('explosion', 'img/Shard.png');
                    game.load.image('person', 'img/Person.png');
                }

                function create () {
                    game.stage.backgroundColor = "#555555";
                    game.world.setBounds(0, 0, 1920, 800);
                    
                    game.physics.startSystem(Phaser.Physics.P2JS);
                    
                    game.physics.p2.setImpactEvents(true);
                    
                    game.physics.p2.gravity.y = GRAVITY;
                    
                    objectCollisionGroup = game.physics.p2.createCollisionGroup();
                    personCollisionGroup = game.physics.p2.createCollisionGroup();
                    grenadeCollisionGroup = game.physics.p2.createCollisionGroup();
                    shardCollisionGroup = game.physics.p2.createCollisionGroup();
                    game.physics.p2.updateBoundsCollisionGroup();
                    
                    var background = game.add.sprite(0, 0, 'background');
                    background.fixedToCamera = true;
                    
                    //NOTE: phaser objects can only be in one group at a time!
                    people = game.add.group();
                    people.enableBody = true;
                    people.physicsBodyType = Phaser.Physics.P2JS;
                    
                    projectiles = new Object();
                    projectiles.grenades = game.add.group();
                    projectiles.grenades.enableBody = true;
                    projectiles.grenades.physicsBodyType = Phaser.Physics.P2JS;
                    
                    projectiles.shards = game.add.group();
                    projectiles.shards.enableBody = true;
                    projectiles.shards.physicsBodyType = Phaser.Physics.P2JS;

                    
                    currentLevel = 0;
                    loadLevel(currentLevel);
                }
                
                function loadLevel(levelIdx) {
                    //Delete any levels that might exist
                    deleteLevel();
                    
                    objects = game.add.group();
                    objects.enableBody = true;
                    objects.physicsBodyType = Phaser.Physics.P2JS;
                    
                    spawnObject(game.width / 2, game.height - 10, 'ground', true, false);
                    
                    //ground.body.friction = 0.5;
                    
                    
                    if (levelIdx == 0) {
                        //Load Level 0
                        //Load the terrain blocks
                        
                        //Load the people
                        
                    }
                }
                
                function deleteLevel() {
                    if (objects != null) {
                        objects.destroy();
                    }
                    if (projectiles.grenades != null) {
                        projectiles.grenades.destroy();
                        projectiles.grenades = game.add.group();
                        projectiles.grenades.enableBody = true;
                        projectiles.grenades.physicsBodyType = Phaser.Physics.P2JS;
                    }
                    if (projectiles.shards != null) {
                        projectiles.shards.destroy();
                        projectiles.shards = game.add.group();
                        projectiles.shards.enableBody = true;
                        projectiles.shards.physicsBodyType = Phaser.Physics.P2JS;
                    }
                    
                }
                
                //Spawns a physics object
                function spawnObject(xPos, yPos, texture, stationary, breakable) {
                    var block = objects.create(xPos, yPos, texture);
                    block.body.setCollisionGroup(objectCollisionGroup);
                    if (breakable) {
                        block.body.collides(grenadeCollisionGroup, blockCollision, this);
                        block.body.collides(projectiles, blockCollision, this);
                    }
                    else {
                        block.body.collides(grenadeCollisionGroup);
                        block.body.collides(shardCollisionGroup);
                    }
                    block.body.collides(objectCollisionGroup);
                    block.body.collides(personCollisionGroup);
                    block.body.kinematic = stationary;
                }
                
                //Spawns a person
                function spawnPerson(xPos, yPos, textureName) {
                    var person = people.create(xPos, yPos, textureName);
                    person.body.setCollisionGroup(personCollisionGroup);
                    person.body.collides(grenadeCollisionGroup, personCollision, this);
                    person.body.collides(shardCollisionGroup, personCollision, this);
                    person.body.collides(objectCollisionGroup);
                }
                
                function update() {
                    //Check if the game is over
                    
                    var deltaTime = 1;
                    
                    processInput();
                    updateProjectiles(deltaTime);
                }
                
                function processInput() {
                    //Check if a grenade needs to be spawned
                    if (game.input.activePointer.leftButton.isDown && !mouseWasDown) {
                        spawnGrenade();
                        mouseWasDown = true;
                    }
                    else if (!game.input.activePointer.leftButton.isDown) {
                        mouseWasDown = false;
                    }
                }
                
                function updateProjectiles(deltaTime) {
                    //Update grenades
                    projectiles.grenades.forEach(function(grenade) {
                        game.camera.follow(grenade);

                        //Update the grenade's angle if it has not already collided
                        if (!grenadeCollided && grenade.body.velocity.y != 0.0 && grenade.body.velocity.x != 0.0) {
                            grenade.body.angle = 180.0 * Math.atan((grenade.body.velocity.y) / (grenade.body.velocity.x)) / Math.PI;
                        }

                        grenade.timeRemaining--;
                        if (grenade.timeRemaining <= 0.0) {
                            //Grenade Explodes
                            explodeGrenade(grenade);
                            projectiles.grenades.remove(grenade);
                        }
                    });
                    
                    //Update shards
                    projectiles.shards.forEach(function(shard) {
                        if (shard != null) {
                            shard.timeRemaining -= deltaTime;
                            if (shard.timeRemaining <= 0) {
                                projectiles.shards.remove(shard);
                                shard.destroy();
                            }
                        }
                    });
                }
                
                function spawnGrenade() {
                    var grenade = projectiles.grenades.create(0, game.height - 50, 'grenade');
                    
                    grenade.body.velocity.x = GRENADE_VELOCITY * Math.cos((Math.PI * 45) / 180.0);
                    grenade.body.velocity.y = GRENADE_VELOCITY * Math.sin((Math.PI * 45) / 180.0);
                    //grenade.body.acceleration.y = GRAVITY;
                    //grenade.body.angle = cannon.angle;
                    grenade.body.collideWorldBounds = false;
                    grenade.timeRemaining = GRENADE_LIFETIME;
                    grenade.body.setCollisionGroup(grenadeCollisionGroup);
                    grenade.body.collides(objectCollisionGroup, grenadeCollision, this);
                    grenade.body.collides(personCollisionGroup, grenadeCollision, this);
                    
                    grenadeCollided = false;
                    
                    game.camera.follow(grenade);
                    
                }
                
                function explodeGrenade(grenade) {
                    spawnExplosion(grenade.body.x, grenade.body.y);
                    
                    grenade.destroy();
                    grenade = null;
                    console.log("GRENADE EXPLODED");
                    
                }
                
                function spawnExplosion(xPos, yPos) {
                    //A bunch of random projectiles that shoot out and destroy objects
                    spawnGrenadeShard(xPos, yPos, 0, EXPLOSION_VELOCITY, EXPLOSION_LIFETIME);
                    spawnGrenadeShard(xPos, yPos, Math.PI / 4, EXPLOSION_VELOCITY, EXPLOSION_LIFETIME);
                    spawnGrenadeShard(xPos, yPos, Math.PI / 2, EXPLOSION_VELOCITY, EXPLOSION_LIFETIME);
                    spawnGrenadeShard(xPos, yPos, (3 * Math.PI) / 4, EXPLOSION_VELOCITY, EXPLOSION_LIFETIME);
                    spawnGrenadeShard(xPos, yPos, Math.PI, EXPLOSION_VELOCITY, EXPLOSION_LIFETIME);
                    spawnGrenadeShard(xPos, yPos, (5 * Math.PI) / 4, EXPLOSION_VELOCITY, EXPLOSION_LIFETIME);
                    spawnGrenadeShard(xPos, yPos, (3 * Math.PI) / 2, EXPLOSION_VELOCITY, EXPLOSION_LIFETIME);
                    spawnGrenadeShard(xPos, yPos, (7 * Math.PI) / 4, EXPLOSION_VELOCITY, EXPLOSION_LIFETIME);
                    
                }
                
                //Takes in an angle in radians(?)
                function spawnGrenadeShard(xPos, yPos, angle, velocity, lifetime) {
                    //Make sure the angle is between 0 and 2PI, but not equal to 2PI
                    while (angle < 0 || angle > 2 * Math.PI) {
                        if (angle < 0) {
                            angle += 2 * Math.PI;
                        }
                        else if (angle > 2 * Math.PI) {
                            angle -= 2 * Math.PI;
                        }
                    }
                    var shard = projectiles.shards.create(xPos, yPos, 'explosion');
                    shard.body.setCollisionGroup(shardCollisionGroup);
                    shard.body.collideWorldBounds = false;
                    shard.body.collides(objectCollisionGroup);
                    shard.body.collides(personCollisionGroup);
                    shard.body.velocity.x = velocity * Math.cos(angle);
                    shard.body.velocity.y = velocity * Math.sin(angle);
                    shard.timeRemaining = lifetime;
                }
                
                function grenadeCollision() {
                    grenadeCollided = true;
                }
                
                function blockCollision(body, shapeA, shapeB, equation) {
                    //Decrement the health of the block
                    if (body != null) {
                        body.sprite.health--;
                        //body.sprite.destroy();
                    }
                }
                
                function personCollision(body, shapeA, shapeB, equation) {
                    //Delete the person that collided
                    if (body != null) {
                        body.sprite.destroy();
                        numDead++;
                        console.log("PERSON KILLED");
                    }
                }
            };

        </script>

    </body>
</html>